
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>پاسور | مدیریت بازی با تم دارک</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* متغیرهای تم دارک */
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --accent: #fbbf24;
            --accent-hover: #f59e0b;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --success: #22c55e;
            --border-radius: 28px;
            --spacing: 16px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--bg-primary);
            font-family: 'Vazir', 'Tahoma', system-ui, -apple-system, sans-serif;
            color: var(--text-primary);
            padding: var(--spacing);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            background: var(--bg-secondary);
            border-radius: 32px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            padding: 24px;
        }

        /* دکمه‌ها */
        button {
            touch-action: manipulation;
            font-size: 16px;
            border: none;
            background: var(--accent);
            color: #0f172a;
            padding: 12px 20px;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        button i {
            font-size: 1.2rem;
        }

        button:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
        }

        button.secondary {
            background: #475569;
            color: white;
        }

        button.secondary:hover {
            background: #64748b;
        }

        button.danger {
            background: var(--danger);
            color: white;
        }

        button.danger:hover {
            background: var(--danger-hover);
        }

        button:disabled {
            opacity: 0.5;
            transform: none;
            pointer-events: none;
        }

        /* هدر ابزار */
        .header-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 24px;
            background: var(--bg-card);
            padding: 16px;
            border-radius: 48px;
            align-items: center;
        }

        .input-group {
            display: flex;
            gap: 8px;
            flex-grow: 1;
        }

        .input-group input {
            flex: 1;
            padding: 14px 20px;
            border: 1px solid #475569;
            border-radius: 40px;
            font-size: 1rem;
            outline: none;
            background: #1e293b;
            color: white;
            transition: 0.2s;
        }

        .input-group input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.2);
        }

        /* بخش بازی فعلی */
        .current-game {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 30px;
            border: 1px solid #475569;
        }

        .current-game h2 {
            color: var(--accent);
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.8rem;
        }

        .matchup {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }

        .team-card {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 20px;
            flex: 1 1 280px;
            text-align: center;
            border: 1px solid #4b5563;
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.4);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .team-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 20px rgba(0, 0, 0, 0.5);
        }

        .team-card h3 {
            color: var(--accent);
            font-size: 2rem;
            margin-bottom: 12px;
            word-break: break-word;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin: 16px 0;
            font-size: 1.2rem;
        }

        .stats span {
            background: #0f172a;
            padding: 8px 16px;
            border-radius: 40px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #475569;
        }

        .stats i {
            color: var(--accent);
        }

        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-top: 16px;
        }

        .actions button {
            flex: 1 0 120px;
            background: #fbbf24;
            color: #0f172a;
        }

        .actions button i {
            color: #0f172a;
        }

        .actions button.kot-hakemi {
            background: var(--danger);
            color: white;
        }

        .actions button.kot-hakemi i {
            color: white;
        }

        /* لیست تیم‌ها */
        .teams-list {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 20px;
            margin-top: 20px;
        }

        .teams-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .teams-header h3 {
            color: var(--accent);
        }

        .team-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #1e293b;
            padding: 12px 20px;
            border-radius: 40px;
            margin-bottom: 10px;
            border: 1px solid #4b5563;
            flex-wrap: wrap;
            gap: 12px;
        }

        .team-info {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .team-name {
            font-weight: 700;
            font-size: 1.2rem;
            min-width: 100px;
            color: var(--text-primary);
        }

        .stat-control {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #0f172a;
            padding: 6px 12px;
            border-radius: 40px;
            border: 1px solid #475569;
        }

        .stat-control button {
            padding: 4px 10px;
            font-size: 1rem;
            background: transparent;
            color: var(--accent);
            box-shadow: none;
        }

        .stat-control button:hover {
            background: #334155;
            transform: none;
        }

        .stat-control span {
            min-width: 30px;
            text-align: center;
            font-weight: 600;
            color: white;
        }

        .stat-control i {
            color: var(--accent);
        }

        .remove-btn {
            background: #7f1d1d;
            color: #fecaca;
            border: none;
            padding: 8px 16px;
            border-radius: 40px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: 0.2s;
        }

        .remove-btn:hover:not(:disabled) {
            background: #991b1b;
            color: white;
        }

        .remove-btn:disabled {
            opacity: 0.3;
        }

        /* انیمیشن قرعه‌کشی */
        .shaking {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            20% { transform: translateX(-10px) rotate(-2deg); }
            40% { transform: translateX(10px) rotate(2deg); }
            60% { transform: translateX(-5px) rotate(-1deg); }
            80% { transform: translateX(5px) rotate(1deg); }
            100% { transform: translateX(0); }
        }

        /* استایل مودال (جدید) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            width: 100%;
            max-width: 600px;
            border-radius: 24px;
            border: 1px solid var(--accent);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            color: var(--accent);
            font-size: 1.5rem;
        }

        .modal-close {
            background: transparent;
            color: var(--text-secondary);
            font-size: 1.5rem;
            padding: 0;
            width: auto;
            box-shadow: none;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
        }

        .stats-table th, .stats-table td {
            text-align: center;
            padding: 12px;
            border-bottom: 1px solid #334155;
        }

        .stats-table th {
            color: var(--accent);
            font-weight: bold;
        }

        .stats-table tr:last-child td {
            border-bottom: none;
        }

        .rank-badge {
            display: inline-block;
            width: 30px;
            height: 30px;
            line-height: 30px;
            border-radius: 50%;
            background: #334155;
            font-weight: bold;
        }
        
        .rank-1 { background: #ffd700; color: black; }
        .rank-2 { background: #c0c0c0; color: black; }
        .rank-3 { background: #cd7f32; color: black; }

        footer {
            margin-top: 24px;
            text-align: center;
            color: #94a3b8;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        /* واکنش‌گرایی موبایل */
        @media (max-width: 600px) {
            .container { padding: 16px; }
            .header-actions { flex-direction: column; align-items: stretch; }
            .input-group { width: 100%; }
            .team-card { flex: 1 1 100%; }
            .team-row { flex-direction: column; align-items: flex-start; }
            .team-info { width: 100%; justify-content: space-between; }
            .stats { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
<div class="container" id="app">
    <h1 style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
        <i class="fas fa-dragon" style="color: var(--accent);"></i> مدیریت بازی پاسور
    </h1>

    <div class="header-actions">
        <div class="input-group">
            <input type="text" id="teamNameInput" placeholder="نام تیم جدید..." maxlength="20">
            <button id="addTeamBtn"><i class="fas fa-plus-circle"></i> افزودن</button>
        </div>
        <button id="drawBtn" class="secondary"><i class="fas fa-shuffle"></i> قرعه‌کشی</button>
        <button id="resetStatsBtn" class="secondary"><i class="fas fa-rotate-left"></i> ریست فعلی</button>
        <button id="finishGameBtn" class="danger"><i class="fas fa-flag-checkered"></i> پایان بازی</button>
    </div>

    <div class="current-game" id="currentGameSection">
        <h2><i class="fas fa-swords"></i> بازی فعلی</h2>
        <div id="matchupContainer" class="matchup">
            </div>
    </div>

    <div class="teams-list">
        <div class="teams-header">
            <h3><i class="fas fa-list-ul"></i> لیست تیم‌ها</h3>
            <span id="teamsCount" style="color: var(--text-secondary);">۰ تیم</span>
        </div>
        <div id="teamsListContainer">
            </div>
    </div>

    <footer>
        <button id="overallStatsBtn" class="secondary" style="width: 100%; max-width: 300px;">
            <i class="fas fa-chart-bar"></i> نمایش آمار کلی (تورنمنت)
        </button>
        <span>برای ویرایش دستی از دکمه‌های + و - استفاده کنید</span>
    </footer>
</div>

<div class="modal-overlay" id="statsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-trophy"></i> جدول رده‌بندی کل</h3>
            <button class="modal-close" id="closeModalBtn"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>رتبه</th>
                        <th>نام تیم</th>
                        <th>قهرمانی</th>
                        <th>کل دست‌های برده</th>
                    </tr>
                </thead>
                <tbody id="statsTableBody">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    (function() {
        // وضعیت اصلی برنامه
        let teams = [];
        let teamOrder = [];

        const STORAGE_KEY = 'pasourGameData';

        // عناصر DOM
        const teamNameInput = document.getElementById('teamNameInput');
        const addTeamBtn = document.getElementById('addTeamBtn');
        const drawBtn = document.getElementById('drawBtn');
        const resetStatsBtn = document.getElementById('resetStatsBtn');
        const finishGameBtn = document.getElementById('finishGameBtn'); // دکمه جدید
        const overallStatsBtn = document.getElementById('overallStatsBtn'); // دکمه جدید
        const matchupContainer = document.getElementById('matchupContainer');
        const teamsListContainer = document.getElementById('teamsListContainer');
        const teamsCountSpan = document.getElementById('teamsCount');
        
        // عناصر مودال
        const statsModal = document.getElementById('statsModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const statsTableBody = document.getElementById('statsTableBody');

        // توابع کمکی
        function generateId() {
            return Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        function saveToLocalStorage() {
            const data = { teams, teamOrder };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    teams = data.teams || [];
                    teamOrder = data.teamOrder || [];
                    // اطمینان از وجود فیلدهای جدید برای رکوردهای قدیمی
                    teams.forEach(t => {
                        if (typeof t.championships === 'undefined') t.championships = 0;
                        if (typeof t.totalSetsWon === 'undefined') t.totalSetsWon = 0;
                    });
                } catch (e) {
                    console.error('خطا در بارگذاری داده‌ها', e);
                }
            }
        }

        function resetAllPisAndKots() {
            teams.forEach(t => {
                t.pis = 0;
                t.singleKots = 0;
                t.wins = 0; // این ریست برای بازی جدید است
            });
        }

        function updateTeamsCount() {
            teamsCountSpan.textContent = teams.length + ' تیم';
        }

        // عملیات باخت
        function handleLoss(loserId) {
            if (teamOrder.length < 2) return;
            const currentFirstId = teamOrder[0];
            const currentSecondId = teamOrder[1];
            if (loserId !== currentFirstId && loserId !== currentSecondId) return;

            const winnerId = (loserId === currentFirstId) ? currentSecondId : currentFirstId;
            const winnerTeam = teams.find(t => t.id === winnerId);
            const loserTeam = teams.find(t => t.id === loserId);
            if (!winnerTeam || !loserTeam) return;

            winnerTeam.wins += 1;
            winnerTeam.pis = 0;
            winnerTeam.singleKots = 0;
            loserTeam.pis = 0;
            loserTeam.singleKots = 0;

            const loserIndex = teamOrder.indexOf(loserId);
            if (loserIndex !== -1) {
                teamOrder.splice(loserIndex, 1);
                teamOrder.push(loserId);
            }

            saveToLocalStorage();
            render();
        }

        // افزایش پیس (بازی)
        function handleIncrementPis(teamId) {
            const team = teams.find(t => t.id === teamId);
            if (!team) return;
            if (teamOrder.length < 2 || (teamId !== teamOrder[0] && teamId !== teamOrder[1])) {
                alert('این تیم در حال حاضر بازی نمی‌کند.');
                return;
            }
            team.pis = (team.pis || 0) + 1;
            if (team.pis >= 4) {
                handleLoss(teamId);
            } else {
                saveToLocalStorage();
                render();
            }
        }

        // کاهش پیس (دستی)
        function handleDecrementPis(teamId) {
            const team = teams.find(t => t.id === teamId);
            if (!team) return;
            if (team.pis > 0) {
                team.pis -= 1;
                saveToLocalStorage();
                render();
            }
        }

        // افزایش کوت تکی (بازی)
        function handleIncrementSingleKot(teamId) {
            const team = teams.find(t => t.id === teamId);
            if (!team) return;
            if (teamOrder.length < 2 || (teamId !== teamOrder[0] && teamId !== teamOrder[1])) {
                alert('این تیم در حال حاضر بازی نمی‌کند.');
                return;
            }
            team.singleKots = (team.singleKots || 0) + 1;
            if (team.singleKots >= 2) {
                handleLoss(teamId);
            } else {
                saveToLocalStorage();
                render();
            }
        }

        // کاهش کوت تکی (دستی)
        function handleDecrementSingleKot(teamId) {
            const team = teams.find(t => t.id === teamId);
            if (!team) return;
            if (team.singleKots > 0) {
                team.singleKots -= 1;
                saveToLocalStorage();
                render();
            }
        }

        // کوت حاکمی
        function handleHakemiKot(teamId) {
            const team = teams.find(t => t.id === teamId);
            if (!team) return;
            if (teamOrder.length < 2 || (teamId !== teamOrder[0] && teamId !== teamOrder[1])) {
                alert('این تیم در حال حاضر بازی نمی‌کند.');
                return;
            }
            handleLoss(teamId);
        }

        // باخت مستقیم دستی
        function handleManualLoss(teamId) {
            const team = teams.find(t => t.id === teamId);
            if (!team) return;
            if (teamOrder.length < 2 || (teamId !== teamOrder[0] && teamId !== teamOrder[1])) {
                alert('این تیم در حال حاضر بازی نمی‌کند.');
                return;
            }
            handleLoss(teamId);
        }

        // افزایش برد کلی (دستی)
        function handleIncrementWin(teamId) {
            const team = teams.find(t => t.id === teamId);
            if (!team) return;
            team.wins += 1;
            saveToLocalStorage();
            render();
        }

        function handleDecrementWin(teamId) {
            const team = teams.find(t => t.id === teamId);
            if (!team) return;
            if (team.wins > 0) {
                team.wins -= 1;
                saveToLocalStorage();
                render();
            }
        }

        // افزودن تیم
        function addTeam(name) {
            if (!name.trim()) {
                alert('لطفاً نام تیم را وارد کنید.');
                return;
            }
            if (teams.some(t => t.name === name.trim())) {
                alert('تیمی با این نام وجود دارد.');
                return;
            }
            const newTeam = {
                id: generateId(),
                name: name.trim(),
                wins: 0,
                pis: 0,
                singleKots: 0,
                championships: 0, // آمار کلی جدید
                totalSetsWon: 0   // آمار کلی جدید
            };
            teams.push(newTeam);
            teamOrder.push(newTeam.id);
            teamNameInput.value = '';
            saveToLocalStorage();
            render();
        }

        // حذف تیم
        function removeTeam(teamId) {
            if (teamOrder.length >= 2 && (teamId === teamOrder[0] || teamId === teamOrder[1])) {
                alert('امکان حذف تیم در حال بازی وجود ندارد.');
                return;
            }
            teams = teams.filter(t => t.id !== teamId);
            teamOrder = teamOrder.filter(id => id !== teamId);
            saveToLocalStorage();
            render();
        }

        // قرعه‌کشی با انیمیشن
        function shuffleAndStart() {
            if (teams.length < 2) {
                alert('حداقل به دو تیم نیاز دارید.');
                return;
            }

            const cards = document.querySelectorAll('.team-card');
            cards.forEach(card => card.classList.add('shaking'));
            drawBtn.innerHTML = '<i class="fas fa-spinner fa-pulse"></i> در حال قرعه‌کشی...';
            drawBtn.disabled = true;

            setTimeout(() => {
                for (let i = teamOrder.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [teamOrder[i], teamOrder[j]] = [teamOrder[j], teamOrder[i]];
                }

                resetAllPisAndKots();
                saveToLocalStorage();

                cards.forEach(card => card.classList.remove('shaking'));
                drawBtn.innerHTML = '<i class="fas fa-shuffle"></i> قرعه‌کشی';
                drawBtn.disabled = false;

                render();
            }, 500);
        }

        // ----------------------------------------
        // توابع جدید مربوط به آمار کلی و پایان بازی
        // ----------------------------------------

        function finishGame() {
            if (teams.length < 2) {
                alert('تیمی برای پایان بازی وجود ندارد.');
                return;
            }

            if (!confirm('آیا مطمئن هستید که می‌خواهید بازی را تمام کنید؟\nاین کار باعث ذخیره آمار در جدول کلی و ریست شدن امتیازهای فعلی می‌شود.')) {
                return;
            }

            // ۱. پیدا کردن بیشترین تعداد برد در حال حاضر
            let maxWins = 0;
            teams.forEach(t => {
                if (t.wins > maxWins) maxWins = t.wins;
            });

            // ۲. دادن امتیاز قهرمانی به تیمی (یا تیم‌هایی) که بیشترین برد را دارند
            // شرط maxWins > 0 برای این است که اگر همه صفر بودند، کسی قهرمان نشود
            teams.forEach(t => {
                if (t.wins === maxWins && maxWins > 0) {
                    t.championships = (t.championships || 0) + 1;
                }
                
                // ۳. اضافه کردن بردهای فعلی به کل تاریخچه برای همه تیم‌ها
                t.totalSetsWon = (t.totalSetsWon || 0) + (t.wins || 0);
            });

            // ۴. ریست کردن تمام امتیازات صفحه اصلی (پیس، کوت، بردهای فعلی)
            resetAllPisAndKots();

            saveToLocalStorage();
            render();
            
            // باز کردن مودال آمار برای نمایش نتیجه نهایی
            showOverallStats();
        }

        function showOverallStats() {
            // مرتب‌سازی تیم‌ها: اول بر اساس تعداد قهرمانی، بعد تعداد دست‌های برده
            const sortedTeams = [...teams].sort((a, b) => {
                if ((b.championships || 0) !== (a.championships || 0)) {
                    return (b.championships || 0) - (a.championships || 0);
                }
                return (b.totalSetsWon || 0) - (a.totalSetsWon || 0);
            });

            let html = '';
            if (sortedTeams.length === 0) {
                html = '<tr><td colspan="4">تیمی وجود ندارد</td></tr>';
            } else {
                sortedTeams.forEach((t, index) => {
                    let rankClass = '';
                    if (index === 0) rankClass = 'rank-1';
                    else if (index === 1) rankClass = 'rank-2';
                    else if (index === 2) rankClass = 'rank-3';

                    html += `
                        <tr>
                            <td><span class="rank-badge ${rankClass}">${index + 1}</span></td>
                            <td style="font-weight: bold; color: white;">${t.name}</td>
                            <td><i class="fas fa-trophy" style="color: gold;"></i> ${t.championships || 0}</td>
                            <td>${t.totalSetsWon || 0} دست</td>
                        </tr>
                    `;
                });
            }

            statsTableBody.innerHTML = html;
            statsModal.classList.add('active');
        }

        function closeStatsModal() {
            statsModal.classList.remove('active');
        }

        // ریست پیس و کوت (بدون تغییر بردها)
        function resetStats() {
            if(!confirm('فقط پیس و کوت‌های بازی فعلی صفر می‌شوند. ادامه می‌دهید؟')) return;
            // فقط پیس و کوت ریست شود، نه بردها (طبق کد قبلی اما با اصلاح باگ احتمالی)
            teams.forEach(t => {
                t.pis = 0;
                t.singleKots = 0;
            });
            saveToLocalStorage();
            render();
        }

        // رندر اصلی
        function render() {
            updateTeamsCount();

            // رندر بازی فعلی
            if (teamOrder.length >= 2) {
                const team1Id = teamOrder[0];
                const team2Id = teamOrder[1];
                const team1 = teams.find(t => t.id === team1Id);
                const team2 = teams.find(t => t.id === team2Id);

                if (team1 && team2) {
                    matchupContainer.innerHTML = `
                        <div class="team-card">
                            <h3><i class="fas fa-crown" style="color: gold; font-size: 1rem; vertical-align: middle;"></i> ${team1.name}</h3>
                            <div class="stats">
                                <span><i class="fas fa-trophy"></i> ${team1.wins}</span>
                                <span><i class="fas fa-layer-group"></i> ${team1.pis}</span>
                                <span><i class="fas fa-bolt"></i> ${team1.singleKots}</span>
                            </div>
                            <div class="actions">
                                <button class="pis-btn" data-team-id="${team1.id}"><i class="fas fa-layer-group"></i> +پیس</button>
                                <button class="kot-taki-btn" data-team-id="${team1.id}"><i class="fas fa-bolt"></i> +کوت تکی</button>
                                <button class="kot-hakemi-btn" data-team-id="${team1.id}"><i class="fas fa-fire"></i> کوت حاکمی</button>
                                <button class="manual-loss-btn" data-team-id="${team1.id}"><i class="fas fa-times-circle"></i> باخت</button>
                            </div>
                        </div>
                        <div class="team-card">
                            <h3>${team2.name}</h3>
                            <div class="stats">
                                <span><i class="fas fa-trophy"></i> ${team2.wins}</span>
                                <span><i class="fas fa-layer-group"></i> ${team2.pis}</span>
                                <span><i class="fas fa-bolt"></i> ${team2.singleKots}</span>
                            </div>
                            <div class="actions">
                                <button class="pis-btn" data-team-id="${team2.id}"><i class="fas fa-layer-group"></i> +پیس</button>
                                <button class="kot-taki-btn" data-team-id="${team2.id}"><i class="fas fa-bolt"></i> +کوت تکی</button>
                                <button class="kot-hakemi-btn" data-team-id="${team2.id}"><i class="fas fa-fire"></i> کوت حاکمی</button>
                                <button class="manual-loss-btn" data-team-id="${team2.id}"><i class="fas fa-times-circle"></i> باخت</button>
                            </div>
                        </div>
                    `;
                } else {
                    matchupContainer.innerHTML = '<div class="empty-state">خطا در بارگذاری تیم‌ها</div>';
                }
            } else {
                matchupContainer.innerHTML = '<div class="empty-state"><i class="fas fa-users-slash"></i> برای شروع بازی حداقل دو تیم لازم است.</div>';
            }

            // رندر لیست تیم‌ها
            if (teams.length === 0) {
                teamsListContainer.innerHTML = '<div class="empty-state">هیچ تیمی ثبت نشده است.</div>';
            } else {
                let teamsHtml = '';
                teams.forEach(team => {
                    const isPlaying = teamOrder.length >= 2 && (team.id === teamOrder[0] || team.id === teamOrder[1]);
                    teamsHtml += `
                        <div class="team-row">
                            <div class="team-info">
                                <span class="team-name">${team.name}</span>
                                <div class="stat-control">
                                    <button class="small inc-win" data-team-id="${team.id}"><i class="fas fa-plus"></i></button>
                                    <span><i class="fas fa-trophy"></i> ${team.wins}</span>
                                    <button class="small dec-win" data-team-id="${team.id}" ${team.wins === 0 ? 'disabled' : ''}><i class="fas fa-minus"></i></button>
                                </div>
                                <div class="stat-control">
                                    <button class="small inc-pis" data-team-id="${team.id}"><i class="fas fa-plus"></i></button>
                                    <span><i class="fas fa-layer-group"></i> ${team.pis}</span>
                                    <button class="small dec-pis" data-team-id="${team.id}" ${team.pis === 0 ? 'disabled' : ''}><i class="fas fa-minus"></i></button>
                                </div>
                                <div class="stat-control">
                                    <button class="small inc-kot" data-team-id="${team.id}"><i class="fas fa-plus"></i></button>
                                    <span><i class="fas fa-bolt"></i> ${team.singleKots}</span>
                                    <button class="small dec-kot" data-team-id="${team.id}" ${team.singleKots === 0 ? 'disabled' : ''}><i class="fas fa-minus"></i></button>
                                </div>
                            </div>
                            <button class="remove-btn" data-team-id="${team.id}" ${isPlaying ? 'disabled' : ''}><i class="fas fa-trash-alt"></i> حذف</button>
                        </div>
                    `;
                });
                teamsListContainer.innerHTML = teamsHtml;
            }

            // اتصال event listeners (بدون تغییر)
            document.querySelectorAll('.pis-btn').forEach(btn => {
                btn.addEventListener('click', (e) => { e.stopPropagation(); handleIncrementPis(btn.dataset.teamId); });
            });
            document.querySelectorAll('.kot-taki-btn').forEach(btn => {
                btn.addEventListener('click', (e) => { e.stopPropagation(); handleIncrementSingleKot(btn.dataset.teamId); });
            });
            document.querySelectorAll('.kot-hakemi-btn').forEach(btn => {
                btn.addEventListener('click', (e) => { e.stopPropagation(); handleHakemiKot(btn.dataset.teamId); });
            });
            document.querySelectorAll('.manual-loss-btn').forEach(btn => {
                btn.addEventListener('click', (e) => { e.stopPropagation(); handleManualLoss(btn.dataset.teamId); });
            });
            document.querySelectorAll('.inc-win').forEach(btn => {
                btn.addEventListener('click', (e) => { e.stopPropagation(); handleIncrementWin(btn.dataset.teamId); });
            });
            document.querySelectorAll('.dec-win').forEach(btn => {
                btn.addEventListener('click', (e) => { e.stopPropagation(); handleDecrementWin(btn.dataset.teamId); });
            });
            document.querySelectorAll('.inc-pis').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const team = teams.find(t => t.id === btn.dataset.teamId);
                    if (team) {
                        team.pis += 1;
                        if (team.pis >= 4 && teamOrder.length >= 2 && (team.id === teamOrder[0] || team.id === teamOrder[1])) {
                            handleLoss(team.id);
                        } else { saveToLocalStorage(); render(); }
                    }
                });
            });
            document.querySelectorAll('.dec-pis').forEach(btn => {
                btn.addEventListener('click', (e) => { e.stopPropagation(); handleDecrementPis(btn.dataset.teamId); });
            });
            document.querySelectorAll('.inc-kot').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const team = teams.find(t => t.id === btn.dataset.teamId);
                    if (team) {
                        team.singleKots += 1;
                        if (team.singleKots >= 2 && teamOrder.length >= 2 && (team.id === teamOrder[0] || team.id === teamOrder[1])) {
                            handleLoss(team.id);
                        } else { saveToLocalStorage(); render(); }
                    }
                });
            });
            document.querySelectorAll('.dec-kot').forEach(btn => {
                btn.addEventListener('click', (e) => { e.stopPropagation(); handleDecrementSingleKot(btn.dataset.teamId); });
            });
            document.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', (e) => { e.stopPropagation(); removeTeam(btn.dataset.teamId); });
            });
        }

        // Event listeners ثابت
        addTeamBtn.addEventListener('click', () => addTeam(teamNameInput.value));
        teamNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addTeam(teamNameInput.value); });
        drawBtn.addEventListener('click', shuffleAndStart);
        resetStatsBtn.addEventListener('click', resetStats);
        
        // لیسنرهای جدید
        finishGameBtn.addEventListener('click', finishGame);
        overallStatsBtn.addEventListener('click', showOverallStats);
        closeModalBtn.addEventListener('click', closeStatsModal);
        statsModal.addEventListener('click', (e) => {
            if (e.target === statsModal) closeStatsModal();
        });

        // بارگذاری اولیه
        loadFromLocalStorage();
        if (teams.length === 0) {
            const defaultNames = ['تیم آبی', 'تیم قرمز', 'تیم سبز', 'تیم زرد'];
            defaultNames.forEach(name => {
                const newTeam = {
                    id: generateId(),
                    name: name,
                    wins: 0,
                    pis: 0,
                    singleKots: 0,
                    championships: 0,
                    totalSetsWon: 0
                };
                teams.push(newTeam);
                teamOrder.push(newTeam.id);
            });
            shuffleAndStart();
        }
        render();
    })();
</script>
</body>
</html>
